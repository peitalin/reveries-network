# default recipe to display help information
default:
  @just --list

# Run runtime crate
run-runtime-umbral:
    cargo run --bin runtime -- test-umbral

# Only on TDX-enabled VMs
run-runtime-tee:
    cargo run --bin runtime --features tdx_enabled -- test-tee

run-runtime-tee2:
    cargo build --features tdx_enabled
    sudo ./target/debug/runtime test-tee

build-tdx:
    cargo build --features tdx_enabled



# Runs node 1
node1:
    cargo run --bin rpc -- \
        --secret-key-seed 1 \
        --rpc-port 8001 \
        --listen-address "/ip4/0.0.0.0/tcp/9001" \
        --bootstrap-peers "/ip4/127.0.0.1/tcp/9002/p2p/12D3KooWH3uVF6wv47WnArKHk5p6cvgCJEb74UTmxztmQDc298L3"

# Runs node1 in Production with node2's IP as bootstrap node
node1-prod:
    sudo cargo build --features tdx_enabled
    sudo ./target/debug/rpc \
        --secret-key-seed 1 \
        --rpc-port 8001 \
        --listen-address "/ip4/0.0.0.0/tcp/9001" \
        --bootstrap-peers "/ip4/35.240.229.229/tcp/9002/p2p/12D3KooWH3uVF6wv47WnArKHk5p6cvgCJEb74UTmxztmQDc298L3"


# Runs node 2
node2:
    cargo run --bin rpc -- \
        --secret-key-seed 2 \
        --rpc-port 8002 \
        --listen-address "/ip4/0.0.0.0/tcp/9002" \
        --bootstrap-peers "/ip4/127.0.0.1/tcp/9001/p2p/12D3KooWPjceQrSwdWXPyLLeABRXmuqt69Rg3sBYbU1Nft9HyQ6X"

# Runs node2 in Production with node1's IP as bootstrap node
node2-prod:
    sudo cargo build --features tdx_enabled
    sudo ./target/debug/rpc \
        --secret-key-seed 2 \
        --rpc-port 8002 \
        --listen-address "/ip4/0.0.0.0/tcp/9002" \
        --bootstrap-peers "/ip4/35.198.200.224/tcp/9001/p2p/12D3KooWPjceQrSwdWXPyLLeABRXmuqt69Rg3sBYbU1Nft9HyQ6X"


# Runs node 3
node3:
    cargo run --bin rpc -- \
        --secret-key-seed 3 \
        --rpc-port 8003 \
        --listen-address "/ip4/0.0.0.0/tcp/9003" \
        --bootstrap-peers "/ip4/127.0.0.1/tcp/9001/p2p/12D3KooWPjceQrSwdWXPyLLeABRXmuqt69Rg3sBYbU1Nft9HyQ6X"

node3-prod:
    sudo cargo build --features tdx_enabled
    sudo ./target/debug/rpc \
        --secret-key-seed 3 \
        --rpc-port 8003 \
        --listen-address "/ip4/0.0.0.0/tcp/9003" \
        --bootstrap-peers "/ip4/35.198.200.224/tcp/9001/p2p/12D3KooWPjceQrSwdWXPyLLeABRXmuqt69Rg3sBYbU1Nft9HyQ6X"


# Runs node 4
node4:
    cargo run --bin rpc -- \
        --secret-key-seed 4 \
        --rpc-port 8004 \
        --listen-address "/ip4/0.0.0.0/tcp/9004" \
        --bootstrap-peers "/ip4/127.0.0.1/tcp/9001/p2p/12D3KooWPjceQrSwdWXPyLLeABRXmuqt69Rg3sBYbU1Nft9HyQ6X"

node4-prod:
    sudo cargo build --features tdx_enabled
    sudo ./target/debug/rpc \
        --secret-key-seed 4 \
        --rpc-port 8004 \
        --listen-address "/ip4/0.0.0.0/tcp/9004" \
        --bootstrap-peers "/ip4/35.198.200.224/tcp/9001/p2p/12D3KooWPjceQrSwdWXPyLLeABRXmuqt69Rg3sBYbU1Nft9HyQ6X"

# Runs node 5
node5:
    cargo run --bin rpc -- \
        --secret-key-seed 5 \
        --rpc-port 8005 \
        --listen-address "/ip4/0.0.0.0/tcp/9005" \
        --bootstrap-peers "/ip4/127.0.0.1/tcp/9001/p2p/12D3KooWPjceQrSwdWXPyLLeABRXmuqt69Rg3sBYbU1Nft9HyQ6X"

node5-prod:
    sudo cargo build --features tdx_enabled
    sudo ./target/debug/rpc \
        --secret-key-seed 5 \
        --rpc-port 8005 \
        --listen-address "/ip4/0.0.0.0/tcp/9005" \
        --bootstrap-peers "/ip4/35.198.200.224/tcp/9001/p2p/12D3KooWPjceQrSwdWXPyLLeABRXmuqt69Rg3sBYbU1Nft9HyQ6X"


# Runs node 6
node6:
    cargo run --bin rpc -- \
        --secret-key-seed 6 \
        --rpc-port 8006 \
        --listen-address "/ip4/0.0.0.0/tcp/9006" \
        --bootstrap-peers "/ip4/127.0.0.1/tcp/9001/p2p/12D3KooWPjceQrSwdWXPyLLeABRXmuqt69Rg3sBYbU1Nft9HyQ6X"

node6-prod:
    sudo cargo build --features tdx_enabled
    sudo ./target/debug/rpc \
        --secret-key-seed 6 \
        --rpc-port 8006 \
        --listen-address "/ip4/0.0.0.0/tcp/9006" \
        --bootstrap-peers "/ip4/35.198.200.224/tcp/9001/p2p/12D3KooWPjceQrSwdWXPyLLeABRXmuqt69Rg3sBYbU1Nft9HyQ6X"


spawn-agent node_port:
    cargo run --bin cmd -- \
        --rpc-server-address 0.0.0.0:{{node_port}} \
        spawn-agent \
        --threshold 2 \
        --total-frags 3


spawn-agent-prod:
    cargo run --bin cmd -- \
        --rpc-server-address 35.198.200.224:8001 \
        spawn-agent \
        --threshold 2 \
        --total-frags 3


trigger-node-failure node_port:
    cargo run --bin cmd -- \
        --rpc-server-address 0.0.0.0:{{node_port}} \
        trigger-node-failure \


get-node-states:
    cargo run --bin cmd -- \
        --rpc-server-address 0.0.0.0:8001 \
        get-node-states \
        --ports 8001,8002,8003,8004


subscribe-heartbeat node_port:
    cargo run --bin cmd -- \
        --rpc-server-address 0.0.0.0:{{node_port}} \
        subscribe-heartbeat

telemetry:
    cargo run --bin telemetry


run-react:
    cd ./telemetry/heartbeat-monitor && npm run dev



terraform-destroy:
    cd terraform && terraform destroy \
    -target=google_compute_instance.tdx_instances \
    -target=google_compute_firewall.allow_rpc_ports


test-rpc-prod:
    cargo run --bin cmd -- \
        --rpc-server-address 35.198.200.224:8001 \
        get-node-states --ports 8001

